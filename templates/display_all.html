 <!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/.  -->
{% extends "base_new.html" %}
{% block title %} FQM - {{ page_title }} {% endblock %}


{% block no_container_content %}
<script type="text/javascript" src="{{ url_for('static', filename='jsonstream.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='audiosequence.min.js') }}"></script>
<script src="{{ url_for('static', filename='extFunctions.js') }}" type='text/javascript'></script>
<script type='text/javascript'>
	var announcement_texts = undefined
	var singleRowQueuing = !!"{% if settings.single_row %}on{% endif %}"
	var audioNotification = "{{'/static/multimedia/'+ts.audio}}"
	var playAudioNotification = '{{ ts.audio}}' != 'false'
	var playAnnouncements = '{{ ts.announce }}' !== 'false'
	var waitForEnding = '{{ ts.wait_for_announcement }}' === 'True'
	var languages = "{{ ts.announce }}".split(',')
	var refreshRate = parseInt("{{ ts.rrate }}") 
	var repeats = parseInt("{{ ts.anr }}")
	var repeatType = "{{ ts.anrt }}"
	var Player = new AudioSequence({
		repeats: repeats,
		repeat_whole: repeatType === 'whole',
		repeat_each: repeatType === 'each',
		auto_start: true,
		autoplay_warning: playAudioNotification || playAnnouncements,
	})
	var processedRepeats = {};

	function play (files) {
		if (files.length) {
			$('video').prop('muted', true)
			if (waitForEnding) Player.playAfter(files)
			else {
				Player.files = files
				Player.load()
			}
		}
	}

	  	
	Player.doAfter(function() { $('video').prop('muted', false) })
	reloadIf(window.location.href, refreshRate)
	$.getJSON("{{ url_for('static', filename='tts.json') }}")
		.then(function(j) {
			announcement_texts = j
			var en = announcement_texts['en-us']

			if (en) announcement_texts['en-us'].message = en.message
				.replace('{}', "{{ alias.office }}")
		})		

		/*var stream1 = JsonStream({
			url: "{{feed_url[0]}}",    
			duration: refreshRate / 1000,
			effect_class: ".effectit-1",
			effect_do_class: ".effectdoit-1",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-1',
			ensure_class: "ensureit-1",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		});

		  var stream2 = JsonStream({
			url: "{{feed_url[1]}}",    
			duration: refreshRate / 1000,
			effect_class: ".effectit-2",
			effect_do_class: ".effectdoit-2",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-2',
			ensure_class: "ensureit-2",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		  });
		
		  var stream3 = JsonStream({
			url: "{{feed_url[2]}}",
			duration: refreshRate / 1000,
			effect_class: ".effectit-3",
			effect_do_class: ".effectdoit-3",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-3',
			ensure_class: "ensureit-3",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',
			effect: "{{ ts.effect }}",
			todo: function(data, toPlay) {}
		  });

		  var stream4 = JsonStream({
			url: "{{feed_url[3]}}",
			duration: refreshRate / 1000,
			effect_class: ".effectit-4",
			effect_do_class: ".effectdoit-4",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: "stream-data-4",
			ensure_class: "ensureit-4",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: "true",
			use_effect_do: "true",
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		  });
		
		var stream5 = JsonStream({
			url: "{{feed_url[4]}}",
			duration: refreshRate / 1000,
			effect_class: ".effectit-5",
			effect_do_class: ".effectdoit-5",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-5',
			ensure_class: "ensureit-5",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		});	
		var stream6 = JsonStream({
			url: "{{feed_url[5]}}",
			duration: refreshRate / 1000,
			effect_class: ".effectit-6",
			effect_do_class: ".effectdoit-6",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-6',
			ensure_class: "ensureit-6",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',	
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		  });
		  
		  var stream7 = JsonStream({
			url: "{{feed_url[6]}}",
			duration: refreshRate / 1000,
			effect_class: ".effectit-7",
			effect_do_class: ".effectdoit-7",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-7',
			ensure_class: "ensureit-7",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		  });
		  
		  var stream8 = JsonStream({
			url: "{{feed_url[7]}}",
			duration: refreshRate / 1000,
			effect_class: ".effectit-8",
			effect_do_class: ".effectdoit-8",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-8',
			ensure_class: "ensureit-8",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		  });
		  
		  var stream9 = JsonStream({
			url: "{{feed_url[8]}}",
			duration: refreshRate / 1000,
			effect_class: ".effectit-9",
			effect_do_class: ".effectdoit-9",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-9',
			ensure_class: "ensureit-9",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		  });
		  
		  var stream10 = JsonStream({
			url: "{{feed_url[9]}}",
			duration: refreshRate / 1000,
			effect_class: ".effectit-10",
			effect_do_class: ".effectdoit-10",
			effect_duration: parseInt("{{ ts.mduration }}"),
			data_attr: 'stream-data-10',
			ensure_class: "ensureit-10",
			ensure_value: "id",
			effect_repeats: parseInt("{{ ts.repeats }}"),
			use_effect: 'true',
			use_effect_do: 'true',
			effect: "{{ ts.effect }}",
			todo: function (data, toPlay) {}
		  });		
		*/	
		
		for (var i = 1; i <= 22; i++) {
			var stream = JsonStream({
			  url: "/feed/" + i,
			  duration: refreshRate / 1000,
			  effect_class: ".effectit-" + i,
			  effect_do_class: ".effectdoit-" + i,
			  effect_duration: parseInt("{{ ts.mduration }}"),
			  data_attr: "stream-data-" + i,
			  ensure_class: "ensureit-" + i,
			  ensure_value: "id",
			  effect_repeats: parseInt("{{ ts.repeats }}"),
			  use_effect: "true",
			  use_effect_do: "true",
			  effect: "{{ ts.effect }}",
			  todo: function(data, toPlay) {}
			});
		  }
		  

				  
		  

	var watcher = setInterval(function () {
		var url = '/repeat_announcement'
		var officeId = '{{ office_id }}'

		if (officeId !== 'None') url += '/' + officeId

		$.get(url)
			.then(function (j) {
				if (j.status && !processedRepeats[j.id]) {
					console.log(processedRepeats);
					play(Player.files)
					processedRepeats[j.id] = true
				}
			})
			.fail(function (e) { console.log(e) })
	}, refreshRate / 2)

</script>
<style>
	.cell {
		display: flex;
		align-items: center;
		justify-content: center;		
		border: 1px solid #ead057;
		width: 23vw;
		height: 23vh;
		margin-bottom: 10px;
		}

	.tasks,.offices{
		margin-bottom: 0px;
	}		
</style>
{% if tv == 0 %}
<div class="row">
    <div class="col-xs-12 text-center">
		<h1 class='mt-1 mb-1 title'> {{ ts.title }} </h1>
    </div>
</div>
<div class="row mt-1">
    <div class="{% if sli.status == 1 or vid.enable == 1 %} col-xs-4 {% else %} col-xs-12 {% endif %} text-center">
		{% if not settings.single_row %}
		<h1 class='offices mb-1'>
			{% if alias.office != 'Office' %}{{ alias.office }}{% else %}{{ translate('Office', 'en', [defLang]) }}{% endif %} : 
			<p stream='con' class='effectit ensureit inline'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
      	<h1 class='tasks mb-1'>
			{% if alias.task != 'Task' %}{{ alias.task }}{% else %}{{ translate('Task', 'en', [defLang]) }}{% endif %} : 
			<p class='effectit ensureit inline' stream='cott'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
		{% endif %}
	    <h1 class='tasks mb-1'>
			{% if alias.ticket != 'Ticket' %}{{ alias.ticket }}{% else %}{{ translate('Ticket', 'en', [defLang]) }}{% endif %} : 
			<p class='effectdoit ensureit inline' stream='cot'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
	</div>
	{% if sli.status == 1 %}
	<div class="col-xs-8">
	    {% if slides.count() >= 1 %}
		<div id="carousel" data-interval="{{ sli.rotation }}" 
			class="carousel slide {% if sli.effect == 'fade' %} carousel-fade {% endif %}" data-ride="carousel"
		>
	    	<ol class="carousel-indicators">
				{% for vv in range(0, slides.count()) %}
				<li class="{% if vv == 0 %} active {% endif %}" data-target="#carousel" data-slide-to="{{ vv }}"></li>
				{% endfor %}
	    	</ol>
	    	<div class="carousel-inner">
				{% for cc in slides %}
				<div class="item {% if cc.id == slides.first().id %} active {% endif %}">
					{% if cc.bname[:3]=="rgb" %}
					<span class="img-responsive slideDim" style="background:{{ cc.bname }};"></span>
					{% else %}
					<img src="{{ url_for('static', filename='multimedia/'+cc.bname) }}" class="img-responsive slideDim">
					{% endif %}
					<div class="carousel-caption">
			    		<h2 style="color: {{ cc.hcolor }}; font-family: {{ cc.hfont }}; font-size: {{ cc.hsize }}; background: {{ cc.hbg }};">{{ cc.title }}</h2>
			    		<p style="color: {{ cc.tcolor }}; font-family: {{ cc.tfont }}; font-size: {{ cc.tsize }}; background: {{ cc.hbg }};">{{ cc.subti }}</p>
					</div>
		    	</div>
		    	{% endfor %}
			</div>
			{% if sli.navigation == 1 %}
			<a class="left carousel-control" href="#carousel" data-slide="prev">
				<i class="icon-prev fa fa-angle-left"></i>
			</a>
			<a class="right carousel-control" href="#carousel" data-slide="next">
				<i class="icon-next fa fa-angle-right"></i>
			</a>
			{% endif %}
	    </div>
		{% else %}
				<h1 class="text-center text-danger bg-muted" style="font-size: 400%">
	    			{{ translate('No slides to be displayed', 'en', [defLang]) }}
				</h1>
		{% endif %}
	</div>  
	{% elif vid.enable == 1 %}
	<div class="col-xs-8">
		<center>
			<video id='vidd' class='img-responsive'
				src="{{ url_for('static', filename='multimedia/'+vid.vname) }}"
				autoplay
				{% if vid.controls == 1 %} controls {% endif %}
				{% if vid.ar == 1 %} loop {% endif %}
				{% if vid.mute == 1 %} muted {% endif %}
			></video>
		</center>
	</div>
	{% endif %}
</div>

<div class="row text-center mt-1">
	<div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w1'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='w2'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w3'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w4'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
</div>
{% if sli.status == 2 and vid.enable == 2 %}
<div class="row text-center mt-1">
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w5'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w6'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w7'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w8'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
</div>
{% endif %}

{% elif tv == 1 %}
<div class="row">
    <div>
		<h1 style="text-align: center;"> {{ts.title}}</h1>
    </div>
</div>
<hr>
<div class="row text-center mt-1" style="text-align:center">	
	<div class="grid">
		{% for i in range(1, 5) %}
		<div class="cell">
		<div class="col-4">
		  <div class="box">
			<h1 class="offices" style="color:#ead057;">
			  عيادة:
			  <u><p stream-data-{{ i }}="con" class="effectit-{{ i }} ensureit-{{ i }} inline" style="display:inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
			<h1 class="tasks" style="color:#ead057;">
			  رقم التذكرة:
			  <u><p class="effectdoit-{{ i }} ensureit-{{ i }} inline" stream-data-{{ i }}="cot" style="display: inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
		  </div>
		</div>
		</div>
		{% endfor %}
	</div>

	<div class="grid">
		{% for i in range(5, 9) %}
		<div class="cell">
		<div class="col-4">
		  <div class="box">
			<h1 class="offices" style="color:#ead057;">
			  عيادة:
			  <u><p stream-data-{{ i }}="con" class="effectit-{{ i }} ensureit-{{ i }} inline" style="display:inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
			<h1 class="tasks" style="color:#ead057;">
			  رقم التذكرة:
			  <u><p class="effectdoit-{{ i }} ensureit-{{ i }} inline" stream-data-{{ i }}="cot" style="display: inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
		  </div>
		</div>
		</div>
		{% endfor %}
	</div>
	
	<div class="grid">
		{% for i in range(9, 13) %}
		<div class="cell">
		<div class="col-4">
		  <div class="box">
			<h1 class="offices" style="color:#ead057;">
			  عيادة:
			  <u><p stream-data-{{ i }}="con" class="effectit-{{ i }} ensureit-{{ i }} inline" style="display:inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
			<h1 class="tasks" style="color:#ead057;">
			  رقم التذكرة:
			  <u><p class="effectdoit-{{ i }} ensureit-{{ i }} inline" stream-data-{{ i }}="cot" style="display: inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
		  </div>
		</div>
		</div>
		{% endfor %}
	</div>

	<div class="grid">
		{% for i in range(13, 17) %}
		<div class="cell">
		<div class="col-4">
		  <div class="box">
			<h1 class="offices" style="color:#ead057;">
			  عيادة:
			  <u><p stream-data-{{ i }}="con" class="effectit-{{ i }} ensureit-{{ i }} inline" style="display:inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
			<h1 class="tasks" style="color:#ead057;">
			  رقم التذكرة:
			  <u><p class="effectdoit-{{ i }} ensureit-{{ i }} inline" stream-data-{{ i }}="cot" style="display: inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
		  </div>
		</div>
		</div>
		{% endfor %}
	</div>
	
	<div class="grid">
		{% for i in range(17, 21) %}
		<div class="cell">
		<div class="col-4">
		  <div class="box">
			<h1 class="offices" style="color:#ead057;">
			  عيادة:
			  <u><p stream-data-{{ i }}="con" class="effectit-{{ i }} ensureit-{{ i }} inline" style="display:inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
			<h1 class="tasks" style="color:#ead057;">
			  رقم التذكرة:
			  <u><p class="effectdoit-{{ i }} ensureit-{{ i }} inline" stream-data-{{ i }}="cot" style="display: inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
		  </div>
		</div>
		</div>
		{% endfor %}
	</div>
	
	<div class="grid">
		{% for i in range(21, 23) %}
		<div class="cell">
		<div class="col-4">
		  <div class="box">
			<h1 class="offices" style="color:#ead057;">
			  عيادة:
			  <u><p stream-data-{{ i }}="con" class="effectit-{{ i }} ensureit-{{ i }} inline" style="display:inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
			<h1 class="tasks" style="color:#ead057;">
			  رقم التذكرة:
			  <u><p class="effectdoit-{{ i }} ensureit-{{ i }} inline" stream-data-{{ i }}="cot" style="display: inline;">{{ translate('Empty', 'en', [defLang]) }}</p></u>
			</h1>
		  </div>
		</div>
		</div>
		{% endfor %}
	</div>		

	  
</div>
{% endif %}
{% endblock %}
